{ parameter
    (or (or (or (string %blacklist_pair) (address %blacklist_user))
            (or (pair %get_price
                   (pair (string %pair)
                         (contract %target
                            (pair (pair (pair (pair (timestamp %close_time) (nat %high_price))
                                              (pair (nat %last_price) (nat %low_price)))
                                        (pair (pair (timestamp %open_time) (string %pair))
                                              (pair (nat %quote_volume) (timestamp %update_time))))
                                  (nat %volume))))
                   (pair (address %target_address) (string %target_entrypoint)))
                (address %harvest_xtz)))
        (or (or (address %set_admin)
                (pair %update
                   (pair (pair (pair (timestamp %close_time) (nat %high_price))
                               (pair (nat %last_price) (nat %low_price)))
                         (pair (pair (timestamp %open_time) (string %pair))
                               (pair (nat %quote_volume) (nat %request_id))))
                   (pair (contract %target
                            (pair (pair (pair (pair (timestamp %close_time) (nat %high_price))
                                              (pair (nat %last_price) (nat %low_price)))
                                        (pair (pair (timestamp %open_time) (string %pair))
                                              (pair (nat %quote_volume) (timestamp %update_time))))
                                  (nat %volume)))
                         (nat %volume))))
            (or (string %whitelist_pair) (address %whitelist_user)))) ;
  storage
    (pair (pair (pair (address %admin) (nat %counter))
                (pair (map %prices
                         string
                         (pair (pair (pair (pair (timestamp %close_time) (nat %high_price))
                                           (pair (nat %last_price) (nat %low_price)))
                                     (pair (pair (timestamp %open_time) (string %pair))
                                           (pair (nat %quote_volume) (timestamp %update_time))))
                               (nat %volume)))
                      (mutez %request_price)))
          (pair (pair (big_map %requests
                         nat
                         (pair (pair (string %pair) (bool %status))
                               (pair (address %target_address) (string %target_entrypoint))))
                      (set %supported_pairs string))
                (set %whitelist address))) ;
  code { UNPAIR ;
         IF_LEFT
           { IF_LEFT
               { IF_LEFT
                   { PUSH string "Only admin" ;
                     DUP 3 ;
                     CAR ;
                     CAR ;
                     CAR ;
                     SENDER ;
                     COMPARE ;
                     EQ ;
                     IF { DROP } { FAILWITH } ;
                     PUSH string "Amount must be 0" ;
                     PUSH mutez 0 ;
                     AMOUNT ;
                     COMPARE ;
                     EQ ;
                     IF { DROP } { FAILWITH } ;
                     SWAP ;
                     DUP ;
                     DUG 2 ;
                     CDR ;
                     CAR ;
                     CDR ;
                     PUSH string "This pair isn't supported" ;
                     SWAP ;
                     DUP ;
                     DUG 2 ;
                     DUP 4 ;
                     MEM ;
                     IF { DROP } { FAILWITH } ;
                     DUP 3 ;
                     CDR ;
                     CDR ;
                     SWAP ;
                     DIG 2 ;
                     PUSH bool False ;
                     SWAP ;
                     UPDATE ;
                     DUP 3 ;
                     CDR ;
                     CAR ;
                     CAR ;
                     PAIR ;
                     PAIR ;
                     SWAP ;
                     CAR ;
                     PAIR ;
                     NIL operation ;
                     PAIR }
                   { PUSH string "Only admin" ;
                     DUP 3 ;
                     CAR ;
                     CAR ;
                     CAR ;
                     SENDER ;
                     COMPARE ;
                     EQ ;
                     IF { DROP } { FAILWITH } ;
                     PUSH string "Amount must be 0" ;
                     PUSH mutez 0 ;
                     AMOUNT ;
                     COMPARE ;
                     EQ ;
                     IF { DROP } { FAILWITH } ;
                     SWAP ;
                     DUP ;
                     DUG 2 ;
                     CDR ;
                     CDR ;
                     PUSH string "User is already blacklisted" ;
                     SWAP ;
                     DUP ;
                     DUG 2 ;
                     DUP 4 ;
                     MEM ;
                     IF { DROP } { FAILWITH } ;
                     SWAP ;
                     PUSH bool False ;
                     SWAP ;
                     UPDATE ;
                     SWAP ;
                     DUP ;
                     DUG 2 ;
                     CDR ;
                     CAR ;
                     PAIR ;
                     SWAP ;
                     CAR ;
                     PAIR ;
                     NIL operation ;
                     PAIR } }
               { IF_LEFT
                   { PUSH string "Invalid amount to create a request" ;
                     PUSH mutez 1000 ;
                     AMOUNT ;
                     COMPARE ;
                     EQ ;
                     IF { DROP } { FAILWITH } ;
                     DUP ;
                     CAR ;
                     CAR ;
                     PUSH string "This pair isn't supported" ;
                     DUP 4 ;
                     CDR ;
                     CAR ;
                     CDR ;
                     DUP 3 ;
                     MEM ;
                     IF { DROP } { FAILWITH } ;
                     DUP 3 ;
                     CAR ;
                     CDR ;
                     CAR ;
                     DUP ;
                     DUP 4 ;
                     CAR ;
                     CAR ;
                     GET ;
                     IF_NONE
                       { PUSH bool True }
                       { NOW ; SWAP ; CAR ; CDR ; CDR ; CDR ; COMPARE ; GE ; NOT } ;
                     DUP 5 ;
                     CAR ;
                     CAR ;
                     CDR ;
                     DUP 6 ;
                     CDR ;
                     CAR ;
                     CAR ;
                     SWAP ;
                     DUP ;
                     DUG 2 ;
                     GET ;
                     IF_NONE
                       { DUP 6 ;
                         CDR ;
                         CAR ;
                         CAR ;
                         DUP 6 ;
                         CDR ;
                         CDR ;
                         DUP 7 ;
                         CDR ;
                         CAR ;
                         PAIR ;
                         DUP 4 ;
                         NOT ;
                         DIG 6 ;
                         PAIR ;
                         PAIR ;
                         DUP 3 ;
                         SWAP ;
                         SOME ;
                         SWAP ;
                         UPDATE }
                       { DIG 4 ; DROP 2 ; PUSH string "Request already exists" ; FAILWITH } ;
                     DIG 2 ;
                     NOT ;
                     IF { DIG 2 ;
                          DUP 4 ;
                          CAR ;
                          CAR ;
                          GET ;
                          IF_NONE { PUSH string "Pair not found" ; FAILWITH } {} ;
                          DIG 3 ;
                          CAR ;
                          CDR ;
                          PUSH mutez 0 ;
                          DIG 2 ;
                          TRANSFER_TOKENS ;
                          DUP 4 ;
                          CDR ;
                          CDR ;
                          DUP 5 ;
                          CDR ;
                          CAR ;
                          CDR ;
                          DIG 3 ;
                          PAIR ;
                          PAIR ;
                          DIG 3 ;
                          CAR ;
                          PAIR ;
                          DUP ;
                          CDR ;
                          SWAP ;
                          DUP ;
                          DUG 2 ;
                          CAR ;
                          CDR ;
                          PUSH int 1 ;
                          DIG 5 ;
                          ADD ;
                          ABS ;
                          DIG 3 ;
                          CAR ;
                          CAR ;
                          CAR ;
                          PAIR ;
                          PAIR ;
                          PAIR ;
                          NIL operation ;
                          DIG 2 ;
                          CONS ;
                          PAIR }
                        { DIG 2 ;
                          DIG 3 ;
                          DROP 2 ;
                          DUP 3 ;
                          CDR ;
                          CDR ;
                          DUP 4 ;
                          CDR ;
                          CAR ;
                          CDR ;
                          DIG 2 ;
                          PAIR ;
                          PAIR ;
                          DIG 2 ;
                          CAR ;
                          PAIR ;
                          DUP ;
                          CDR ;
                          SWAP ;
                          DUP ;
                          DUG 2 ;
                          CAR ;
                          CDR ;
                          PUSH int 1 ;
                          DIG 4 ;
                          ADD ;
                          ABS ;
                          DIG 3 ;
                          CAR ;
                          CAR ;
                          CAR ;
                          PAIR ;
                          PAIR ;
                          PAIR ;
                          NIL operation ;
                          PAIR } }
                   { BALANCE ;
                     SWAP ;
                     CONTRACT unit ;
                     IF_NONE { PUSH string "Invalid address" ; FAILWITH } {} ;
                     SWAP ;
                     UNIT ;
                     TRANSFER_TOKENS ;
                     SWAP ;
                     NIL operation ;
                     DIG 2 ;
                     CONS ;
                     PAIR } } }
           { IF_LEFT
               { IF_LEFT
                   { PUSH string "Only admin" ;
                     DUP 3 ;
                     CAR ;
                     CAR ;
                     CAR ;
                     SENDER ;
                     COMPARE ;
                     EQ ;
                     IF { DROP } { FAILWITH } ;
                     PUSH string "Amount must be 0" ;
                     PUSH mutez 0 ;
                     AMOUNT ;
                     COMPARE ;
                     EQ ;
                     IF { DROP } { FAILWITH } ;
                     SWAP ;
                     DUP ;
                     DUG 2 ;
                     CDR ;
                     DUP 3 ;
                     CAR ;
                     CDR ;
                     DIG 3 ;
                     CAR ;
                     CAR ;
                     CDR ;
                     DIG 3 ;
                     PAIR ;
                     PAIR ;
                     PAIR ;
                     NIL operation ;
                     PAIR }
                   { PUSH string "User isn't whitelisted" ;
                     DUP 3 ;
                     CDR ;
                     CDR ;
                     SENDER ;
                     MEM ;
                     IF { DROP } { FAILWITH } ;
                     DUP ;
                     CAR ;
                     CDR ;
                     CAR ;
                     CDR ;
                     PUSH string "This pair isn't supported" ;
                     DUP 4 ;
                     CDR ;
                     CAR ;
                     CDR ;
                     DUP 3 ;
                     MEM ;
                     IF { DROP } { FAILWITH } ;
                     DUP 3 ;
                     CAR ;
                     CDR ;
                     CAR ;
                     DUP 3 ;
                     CAR ;
                     CDR ;
                     CDR ;
                     CDR ;
                     DUP 5 ;
                     CDR ;
                     CAR ;
                     CAR ;
                     DUP 5 ;
                     CDR ;
                     CDR ;
                     NOW ;
                     DUP 7 ;
                     CAR ;
                     CDR ;
                     CDR ;
                     CAR ;
                     PAIR ;
                     DUP 6 ;
                     DUP 8 ;
                     CAR ;
                     CDR ;
                     CAR ;
                     CAR ;
                     PAIR ;
                     PAIR ;
                     DUP 7 ;
                     CAR ;
                     CAR ;
                     CDR ;
                     CDR ;
                     DUP 8 ;
                     CAR ;
                     CAR ;
                     CDR ;
                     CAR ;
                     PAIR ;
                     DUP 8 ;
                     CAR ;
                     CAR ;
                     CAR ;
                     CDR ;
                     DUP 9 ;
                     CAR ;
                     CAR ;
                     CAR ;
                     CAR ;
                     PAIR ;
                     PAIR ;
                     PAIR ;
                     PAIR ;
                     SWAP ;
                     DUP ;
                     DUG 2 ;
                     DUP 4 ;
                     GET ;
                     IF_NONE
                       { PUSH string "Request not found" ; FAILWITH }
                       { DUP ; CDR ; PUSH bool True ; DIG 2 ; CAR ; CAR ; PAIR ; PAIR } ;
                     DIG 6 ;
                     CDR ;
                     CAR ;
                     PUSH mutez 0 ;
                     DUP 4 ;
                     TRANSFER_TOKENS ;
                     DUP 8 ;
                     CDR ;
                     CDR ;
                     DUP 9 ;
                     CDR ;
                     CAR ;
                     CDR ;
                     DIG 5 ;
                     DIG 4 ;
                     SOME ;
                     DIG 6 ;
                     UPDATE ;
                     PAIR ;
                     PAIR ;
                     DIG 5 ;
                     CAR ;
                     PAIR ;
                     DUP ;
                     CDR ;
                     SWAP ;
                     DUP ;
                     DUG 2 ;
                     CAR ;
                     CDR ;
                     CDR ;
                     DUP 6 ;
                     DUP 8 ;
                     GET ;
                     IF_NONE
                       { DIG 5 ; DIG 5 ; DIG 6 ; SWAP ; SOME ; SWAP ; UPDATE }
                       { DROP ; DIG 5 ; DIG 5 ; SOME ; DIG 6 ; UPDATE } ;
                     PAIR ;
                     DIG 2 ;
                     CAR ;
                     CAR ;
                     PAIR ;
                     PAIR ;
                     NIL operation ;
                     DIG 2 ;
                     CONS ;
                     PAIR } }
               { IF_LEFT
                   { PUSH string "Only admin" ;
                     DUP 3 ;
                     CAR ;
                     CAR ;
                     CAR ;
                     SENDER ;
                     COMPARE ;
                     EQ ;
                     IF { DROP } { FAILWITH } ;
                     PUSH string "Amount must be 0" ;
                     PUSH mutez 0 ;
                     AMOUNT ;
                     COMPARE ;
                     EQ ;
                     IF { DROP } { FAILWITH } ;
                     SWAP ;
                     DUP ;
                     DUG 2 ;
                     CDR ;
                     CAR ;
                     CDR ;
                     PUSH string "This pair is already supported" ;
                     SWAP ;
                     DUP ;
                     DUG 2 ;
                     DUP 4 ;
                     MEM ;
                     NOT ;
                     IF { DROP } { FAILWITH } ;
                     DUP 3 ;
                     CDR ;
                     CDR ;
                     SWAP ;
                     DIG 2 ;
                     PUSH bool True ;
                     SWAP ;
                     UPDATE ;
                     DUP 3 ;
                     CDR ;
                     CAR ;
                     CAR ;
                     PAIR ;
                     PAIR ;
                     SWAP ;
                     CAR ;
                     PAIR ;
                     NIL operation ;
                     PAIR }
                   { PUSH string "Only admin" ;
                     DUP 3 ;
                     CAR ;
                     CAR ;
                     CAR ;
                     SENDER ;
                     COMPARE ;
                     EQ ;
                     IF { DROP } { FAILWITH } ;
                     PUSH string "Amount must be 0" ;
                     PUSH mutez 0 ;
                     AMOUNT ;
                     COMPARE ;
                     EQ ;
                     IF { DROP } { FAILWITH } ;
                     SWAP ;
                     DUP ;
                     DUG 2 ;
                     CDR ;
                     CDR ;
                     PUSH string "User is already whitelisted" ;
                     SWAP ;
                     DUP ;
                     DUG 2 ;
                     DUP 4 ;
                     MEM ;
                     NOT ;
                     IF { DROP } { FAILWITH } ;
                     SWAP ;
                     PUSH bool True ;
                     SWAP ;
                     UPDATE ;
                     SWAP ;
                     DUP ;
                     DUG 2 ;
                     CDR ;
                     CAR ;
                     PAIR ;
                     SWAP ;
                     CAR ;
                     PAIR ;
                     NIL operation ;
                     PAIR } } } } }

